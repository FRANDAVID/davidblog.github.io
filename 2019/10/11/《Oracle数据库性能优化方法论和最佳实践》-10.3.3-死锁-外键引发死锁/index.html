<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="背景知识 外键由于业务规则内置在数据库中，开发人员很难注意到这种业务规则的存在会导致死锁概率的提升。外键约束会导致两个基本的场景：&#x3D;&#x3D;一是删除主表时需要同步删除子表，即需要锁定子表的对应记录**&#x3D;&#x3D;。**二是插入子表需要确保主表记录存在，即需要锁定主表的对应记录。特别是当外键无索引时，Oracle会在子表上请求SX锁，这个锁和一般更新需要S锁不兼容，即只要子表有更新，就无法获得这个锁。也就是说，S">
<meta property="og:type" content="article">
<meta property="og:title" content="《Oracle数据库性能优化方法论和最佳实践》-10.3.3-死锁-外键引发死锁">
<meta property="og:url" content="http://example.com/2019/10/11/%E3%80%8AOracle%E6%95%B0%E6%8D%AE%E5%BA%93%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%96%B9%E6%B3%95%E8%AE%BA%E5%92%8C%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E3%80%8B-10.3.3-%E6%AD%BB%E9%94%81-%E5%A4%96%E9%94%AE%E5%BC%95%E5%8F%91%E6%AD%BB%E9%94%81/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="背景知识 外键由于业务规则内置在数据库中，开发人员很难注意到这种业务规则的存在会导致死锁概率的提升。外键约束会导致两个基本的场景：&#x3D;&#x3D;一是删除主表时需要同步删除子表，即需要锁定子表的对应记录**&#x3D;&#x3D;。**二是插入子表需要确保主表记录存在，即需要锁定主表的对应记录。特别是当外键无索引时，Oracle会在子表上请求SX锁，这个锁和一般更新需要S锁不兼容，即只要子表有更新，就无法获得这个锁。也就是说，S">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://www.ibm.com/developerworks/cn/data/library/techarticles/dm-0512niuxzh/images/table2.gif">
<meta property="og:image" content="https://www.ibm.com/developerworks/cn/data/library/techarticles/dm-0512niuxzh/images/table1.gif">
<meta property="og:image" content="http://images2015.cnblogs.com/blog/824142/201612/824142-20161222210536948-1062959696.png">
<meta property="article:published_time" content="2019-10-11T09:23:00.000Z">
<meta property="article:modified_time" content="2020-10-11T09:18:23.862Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="oracle">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.ibm.com/developerworks/cn/data/library/techarticles/dm-0512niuxzh/images/table2.gif">

<link rel="canonical" href="http://example.com/2019/10/11/%E3%80%8AOracle%E6%95%B0%E6%8D%AE%E5%BA%93%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%96%B9%E6%B3%95%E8%AE%BA%E5%92%8C%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E3%80%8B-10.3.3-%E6%AD%BB%E9%94%81-%E5%A4%96%E9%94%AE%E5%BC%95%E5%8F%91%E6%AD%BB%E9%94%81/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>《Oracle数据库性能优化方法论和最佳实践》-10.3.3-死锁-外键引发死锁 | Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home //首页 fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags //标签 fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th //分类 fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive //归档 fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/10/11/%E3%80%8AOracle%E6%95%B0%E6%8D%AE%E5%BA%93%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%96%B9%E6%B3%95%E8%AE%BA%E5%92%8C%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E3%80%8B-10.3.3-%E6%AD%BB%E9%94%81-%E5%A4%96%E9%94%AE%E5%BC%95%E5%8F%91%E6%AD%BB%E9%94%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          《Oracle数据库性能优化方法论和最佳实践》-10.3.3-死锁-外键引发死锁
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-10-11 17:23:00" itemprop="dateCreated datePublished" datetime="2019-10-11T17:23:00+08:00">2019-10-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-11 17:18:23" itemprop="dateModified" datetime="2020-10-11T17:18:23+08:00">2020-10-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h1><blockquote>
<h6 id="外键由于业务规则内置在数据库中，开发人员很难注意到这种业务规则的存在会导致死锁概率的提升。外键约束会导致两个基本的场景：-一是删除主表时需要同步删除子表，即需要锁定子表的对应记录-。-二是插入子表需要确保主表记录存在，即需要锁定主表的对应记录。特别是当外键无索引时，Oracle会在子表上请求SX锁，这个锁和一般更新需要S锁不兼容，即只要子表有更新，就无法获得这个锁。也就是说，SSX使并发性控制从记录迁移到了表格上，从而使死锁发生的概率大幅度增加。"><a href="#外键由于业务规则内置在数据库中，开发人员很难注意到这种业务规则的存在会导致死锁概率的提升。外键约束会导致两个基本的场景：-一是删除主表时需要同步删除子表，即需要锁定子表的对应记录-。-二是插入子表需要确保主表记录存在，即需要锁定主表的对应记录。特别是当外键无索引时，Oracle会在子表上请求SX锁，这个锁和一般更新需要S锁不兼容，即只要子表有更新，就无法获得这个锁。也就是说，SSX使并发性控制从记录迁移到了表格上，从而使死锁发生的概率大幅度增加。" class="headerlink" title="外键由于业务规则内置在数据库中，开发人员很难注意到这种业务规则的存在会导致死锁概率的提升。外键约束会导致两个基本的场景：==一是删除主表时需要同步删除子表，即需要锁定子表的对应记录**==。**二是插入子表需要确保主表记录存在，即需要锁定主表的对应记录。特别是当外键无索引时，Oracle会在子表上请求SX锁，这个锁和一般更新需要S锁不兼容，即只要子表有更新，就无法获得这个锁。也就是说，SSX使并发性控制从记录迁移到了表格上，从而使死锁发生的概率大幅度增加。"></a>外键由于业务规则内置在数据库中，开发人员很难注意到这种业务规则的存在会导致死锁概率的提升。外键约束会导致两个基本的场景：==<em>一是删除主表时需要同步删除子表，即需要锁定子表的对应记录**</em>==。**二是插入子表需要确保主表记录存在，即需要锁定主表的对应记录。特别是当外键无索引时，Oracle会在子表上请求SX锁，这个锁和一般更新需要S锁不兼容，即只要子表有更新，就无法获得这个锁。也就是说，SSX使并发性控制从记录迁移到了表格上，从而使死锁发生的概率大幅度增加。</h6></blockquote>
<p>参考网址：</p>
<blockquote>
<pre><code>https://www.cnblogs.com/kerrycode/p/6723345.html
https://www.modb.pro/db/22800
https://blog.csdn.net/u013641333/article/details/82751111?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~all~first_rank_v2~rank_v25-2-82751111.nonecase
https://blog.csdn.net/zl834205311/article/details/81742691
https://cloud.tencent.com/developer/article/1451003
https://blog.csdn.net/hotdust/article/details/51258965</code></pre>
</blockquote>
<h1 id="Oracle锁"><a href="#Oracle锁" class="headerlink" title="Oracle锁"></a>Oracle锁</h1><p><img src="https://www.ibm.com/developerworks/cn/data/library/techarticles/dm-0512niuxzh/images/table2.gif" alt="image"></p>
<p><img src="https://www.ibm.com/developerworks/cn/data/library/techarticles/dm-0512niuxzh/images/table1.gif" alt="image"></p>
<h3 id="TM-锁（表级锁）"><a href="#TM-锁（表级锁）" class="headerlink" title="TM 锁（表级锁）"></a>TM 锁（表级锁）</h3><blockquote>
<p>TM 锁用于确保在修改表的内容时，表的结构不会改变，例如防止在 DML 语句执行期间相关的表被移除。当用户对表执行 DDL 或 DML 操作时，将获取一个此表的表级锁。</p>
<p>当事务获得行锁后，此事务也将自动获得该行的表锁(共享锁),以防止其它事务进行 DDL 语句影响记录行的更新。</p>
<p>事务也可以在进行过程中获得共享锁或排它锁，只有当事务显示使用 LOCK TABLE 语句显示的定义一个排它锁时，事务才会获得表上的排它锁,也可使用 LOCK TABLE 显示的定义一个表级的共享锁。</p>
<p>TM 锁包括了 SS、 SX、 S、 X 等多种模式，在数据库中用 0－6 来表示。不同的 SQL 操作产生不同类型的 TM 锁.</p>
</blockquote>
<p>TM 锁类型表<br><img src="http://images2015.cnblogs.com/blog/824142/201612/824142-20161222210536948-1062959696.png" alt="image"></p>
<h2 id="Oracle的TX锁（行级锁、事务锁）"><a href="#Oracle的TX锁（行级锁、事务锁）" class="headerlink" title="Oracle的TX锁（行级锁、事务锁）"></a>Oracle的TX锁（行级锁、事务锁）</h2><blockquote>
<p>许多对Oracle不太了解的技术人员可能会以为每一个TX锁代表一条被封锁的数据行，其实不然。TX的本义是Transaction（事务），当 一个事务第一次执行数据更改（Insert、Update、Delete）或使用SELECT… FOR UPDATE语句进行查询时，它即获得一个TX（事务）锁，直至该事务结束（执行COMMIT或ROLLBACK操作）时，该锁才被释放。所以，一个TX 锁，可以对应多个被该事务锁定的数据行（在我们用的时候多是启动一个事务，然后SELECT… FOR UPDATE NOWAIT）。</p>
<p>在Oracle的每行数据上，都有一个标志位来表示该行数据是否被锁定。Oracle不像DB2那样，建立一个链表来维护每一行被加锁的数据，这样 就大大减小了行级锁的维护开销，也在很大程度上避免了类似DB2使用行级锁时经常发生的锁数量不够而进行锁升级的情况。数据行上的锁标志一旦被置位，就表 明该行数据被加X锁，Oracle在数据行上没有S锁。</p>
</blockquote>
<h1 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h1><blockquote>
<p>==外键未加索引是引发死锁的一大原因。更新父表的主键或者删除父表中的一行都会导致子表产生一个全表锁</p>
<p>  ==<strong>删除主表会自动在字表上追加S锁,但是S锁和RX锁不兼容所以sql会被阻塞</strong>）==。</p>
</blockquote>
<h1 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h1><blockquote>
<pre><code>建立主表
create table PK_TEST
(
  ID   NUMBER not null
    constraint PK_TEST_PK
      primary key,
  NAME VARCHAR2(20)
)
/</code></pre>
</blockquote>
<blockquote>
<pre><code>建立字表
create table FK_TEST
(
  ID   NUMBER not null
    constraint FK_TEST_PK
      primary key,
  NAME VARCHAR2(20),
  PID  NUMBER
    constraint FK_TEST_PK_TEST_ID_FK
      references PK_TEST
        on delete cascade
)
/</code></pre>
</blockquote>
<ul>
<li>情况1：==session1删除主表不提交，session2删除/ 更新=子表应用的主表的字段时，insert新记录都被阻塞==</li>
</ul>
<pre><code>    1.session1中删除一个主表记录，不提交
    2.session2中删除一个字表记录，session被阻塞
    因为删除主表记录时，会自动在字表上申请S锁，此时申请成功，
    当删除字表时事务会在字表上申请RX锁（insert，update，delete）
    但是之前申请的S锁和RX锁不兼容，因此Session2阻塞。</code></pre>
<ul>
<li>情况2：Session1删除子表不提交，Session2删除主表被阻塞</li>
</ul>
<pre><code>    1.session1删除一个字表记录，不提交
    2.session2删除一个主表记录，此时session2被阻塞
    因为删除字表，事务自动申请字表RX锁，同时申请被删除行的TX锁，当session2
    删除主表记录时，事务自动申请被关联的字表的S锁，但是此时session1中已经持有过了RX锁，因此申请S锁失败，session2被阻塞。</code></pre>
<ul>
<li><p>情况3：session1子表插入记录不提交，session2阻塞主表插入操作。</p>
<pre><code>  本地实验未能成功复现</code></pre>
</li>
<li><p>情况4：session1插入子表不提交，session2删除主表任意字段被阻塞。</p>
</li>
</ul>
<ul>
<li>==删除账号导致死锁的实验分析==</li>
</ul>
<pre><code>    1.session1 删除子表（时间长，执行慢），删除主表。此时执行缓慢，新开一个session
    2.session2 重复之前动作
    3.session3 重复之前动作，此时系统已经发生死锁，因为没有回滚机制，导致一直死锁。</code></pre>
<h4 id="查看整个数据库下拥有主外键关系的所有表（排除一些系统用户）"><a href="#查看整个数据库下拥有主外键关系的所有表（排除一些系统用户）" class="headerlink" title="# 查看整个数据库下拥有主外键关系的所有表（排除一些系统用户）"></a># 查看整个数据库下拥有主外键关系的所有表（排除一些系统用户）</h4><pre><code>    SELECT DC.OWNER                   AS &quot;PARENT_TABLE_OWNER&quot;, 
                 DC.TABLE_NAME              AS &quot;PARENT_TABLE_NAME&quot;, 
                 DC.CONSTRAINT_NAME         AS &quot;PRIMARY CONSTRAINT NAME&quot;, 
                 DF.CONSTRAINT_NAME         AS &quot;REFERENCED CONSTRAINT NAME&quot;, 
                 DF.OWNER                   AS &quot;CHILD_TABLE_OWNER&quot;, 
                 DF.TABLE_NAME              AS &quot;CHILD_TABLE_NAME&quot; 
    FROM   DBA_CONSTRAINTS DC, 
                 (SELECT C.OWNER, 
                                 C.CONSTRAINT_NAME, 
                                 C.R_CONSTRAINT_NAME, 
                                 C.TABLE_NAME 
                    FROM   DBA_CONSTRAINTS C 
                    WHERE  CONSTRAINT_TYPE = &#39;R&#39;) DF 
    WHERE  DC.CONSTRAINT_NAME =DF.R_CONSTRAINT_NAME 
                 AND DC.OWNER NOT IN ( &#39;SYSTEM&#39;, &#39;SYS&#39;, &#39;DBSNMP&#39;, &#39;EXFSYS&#39;, 
                                                            &#39;ORDDATA&#39;, &#39;CTXSYS&#39;, &#39;OLAPSYS&#39;, &#39;MDSYS&#39;, 
                                                            &#39;SYSMAN&#39; ); </code></pre>
<h4 id="–查看某个Schema下拥有主外键关系的所有表"><a href="#–查看某个Schema下拥有主外键关系的所有表" class="headerlink" title="–查看某个Schema下拥有主外键关系的所有表"></a>–查看某个Schema下拥有主外键关系的所有表</h4><pre><code>    SELECT DC.OWNER           AS &quot;PARENT_TABLE_OWNER&quot;, 
                 DC.TABLE_NAME      AS &quot;PARENT_TABLE_NAME&quot;, 
                 DC.CONSTRAINT_NAME AS &quot;PRIMARY CONSTRAINT NAME&quot;, 
                 DF.CONSTRAINT_NAME AS &quot;REFERENCED CONSTRAINT NAME&quot;, 
                 DF.OWNER           AS &quot;CHILD_TABLE_OWNER&quot;, 
                 DF.TABLE_NAME      AS &quot;CHILD_TABLE_NAME&quot; 
    FROM   DBA_CONSTRAINTS DC, 
                 (SELECT C.OWNER, 
                                 C.CONSTRAINT_NAME, 
                                 C.R_CONSTRAINT_NAME, 
                                 C.TABLE_NAME 
                    FROM   DBA_CONSTRAINTS C 
                    WHERE  CONSTRAINT_TYPE = &#39;R&#39;) DF 
    WHERE  DC.CONSTRAINT_NAME = DF.R_CONSTRAINT_NAME 
                 AND DC.OWNER =UPPER(&#39;&amp;OWNER&#39;);  </code></pre>
<h4 id="–查看某个具体的表是否和其它表拥有主外键关系"><a href="#–查看某个具体的表是否和其它表拥有主外键关系" class="headerlink" title="–查看某个具体的表是否和其它表拥有主外键关系"></a>–查看某个具体的表是否和其它表拥有主外键关系</h4><pre><code>    SELECT DC.OWNER           AS &quot;PARENT_TABLE_OWNER&quot;, 
                 DC.TABLE_NAME      AS &quot;PARENT_TABLE_NAME&quot;, 
                 DC.CONSTRAINT_NAME AS &quot;PRIMARY CONSTRAINT NAME&quot;, 
                 DF.CONSTRAINT_NAME AS &quot;REFERENCED CONSTRAINT NAME&quot;, 
                 DF.OWNER           AS &quot;CHILD_TABLE_OWNER&quot;, 
                 DF.TABLE_NAME      AS &quot;CHILD_TABLE_NAME&quot; 
    FROM   DBA_CONSTRAINTS DC, 
                 (SELECT C.OWNER, 
                                 C.CONSTRAINT_NAME, 
                                 C.R_CONSTRAINT_NAME, 
                                 C.TABLE_NAME 
                    FROM   DBA_CONSTRAINTS C 
                    WHERE  CONSTRAINT_TYPE = &#39;R&#39;) DF 
    WHERE  DC.CONSTRAINT_NAME = DF.R_CONSTRAINT_NAME 
                 AND DC.OWNER =UPPER(&#39;&amp;OWNER&#39;)
                 AND DC.TABLE_NAME=UPPER(&#39;&amp;TABLE_NAME&#39;);</code></pre>
<h4 id="接下来我们要找出在具体的外键字段是否有索引，脚本如下所示："><a href="#接下来我们要找出在具体的外键字段是否有索引，脚本如下所示：" class="headerlink" title="接下来我们要找出在具体的外键字段是否有索引，脚本如下所示："></a>接下来我们要找出在具体的外键字段是否有索引，脚本如下所示：</h4><pre><code>    SELECT   CON.OWNER ,
                     CON.TABLE_NAME,
                     CON.CONSTRAINT_NAME,
                     CON.COL_LIST,
                     &#39;No Indexed&#39; AS INDEX_STATUS
    FROM
             (SELECT CC.OWNER, CC.TABLE_NAME, CC.CONSTRAINT_NAME,
                         MAX(DECODE(POSITION, 1,     &#39;&quot;&#39; ||
                                        SUBSTR(COLUMN_NAME,1,30) ||&#39;&quot;&#39;,NULL)) ||
                         MAX(DECODE(POSITION, 2,&#39;, &#39;||&#39;&quot;&#39;||
                                        SUBSTR(COLUMN_NAME,1,30) ||&#39;&quot;&#39;,NULL)) ||
                         MAX(DECODE(POSITION, 3,&#39;, &#39;||&#39;&quot;&#39;||
                                        SUBSTR(COLUMN_NAME,1,30) ||&#39;&quot;&#39;,NULL)) ||
                         MAX(DECODE(POSITION, 4,&#39;, &#39;||&#39;&quot;&#39;||
                                        SUBSTR(COLUMN_NAME,1,30) ||&#39;&quot;&#39;,NULL)) ||
                         MAX(DECODE(POSITION, 5,&#39;, &#39;||&#39;&quot;&#39;||
                                        SUBSTR(COLUMN_NAME,1,30) ||&#39;&quot;&#39;,NULL)) ||
                         MAX(DECODE(POSITION, 6,&#39;, &#39;||&#39;&quot;&#39;||
                                        SUBSTR(COLUMN_NAME,1,30) ||&#39;&quot;&#39;,NULL)) ||
                         MAX(DECODE(POSITION, 7,&#39;, &#39;||&#39;&quot;&#39;||
                                        SUBSTR(COLUMN_NAME,1,30) ||&#39;&quot;&#39;,NULL)) ||
                         MAX(DECODE(POSITION, 8,&#39;, &#39;||&#39;&quot;&#39;||
                                        SUBSTR(COLUMN_NAME,1,30) ||&#39;&quot;&#39;,NULL)) ||
                         MAX(DECODE(POSITION, 9,&#39;, &#39;||&#39;&quot;&#39;||
                                        SUBSTR(COLUMN_NAME,1,30) ||&#39;&quot;&#39;,NULL)) ||
                         MAX(DECODE(POSITION, 10,&#39;, &#39;||&#39;&quot;&#39;||
                                        SUBSTR(COLUMN_NAME,1,30) ||&#39;&quot;&#39;,NULL)) COL_LIST
                         FROM DBA_CONSTRAINTS DC, DBA_CONS_COLUMNS CC
                         WHERE DC.OWNER = CC.OWNER
                         AND DC.CONSTRAINT_NAME = CC.CONSTRAINT_NAME
                         AND DC.CONSTRAINT_TYPE = &#39;R&#39;
                         AND DC.OWNER NOT IN (&#39;SYS&#39;, &#39;SYSTEM&#39;, &#39;OLAPSYS&#39;, &#39;SYSMAN&#39;, &#39;MDSYS&#39;, &#39;ADMIN&#39;)
                         GROUP BY CC.OWNER, CC.TABLE_NAME, CC.CONSTRAINT_NAME 
             ) CON
                WHERE NOT EXISTS (
                    SELECT 1 FROM
                                        ( SELECT TABLE_OWNER, TABLE_NAME,   
                                                 MAX(DECODE(COLUMN_POSITION, 1,     &#39;&quot;&#39;||
                                                                SUBSTR(COLUMN_NAME,1,30)  ||&#39;&quot;&#39;,NULL)) ||
                                                 MAX(DECODE(COLUMN_POSITION, 2,&#39;, &#39;||&#39;&quot;&#39;||
                                                                SUBSTR(COLUMN_NAME,1,30)  ||&#39;&quot;&#39;,NULL)) ||
                                                 MAX(DECODE(COLUMN_POSITION, 3,&#39;, &#39;||&#39;&quot;&#39;||
                                                                SUBSTR(COLUMN_NAME,1,30)  ||&#39;&quot;&#39;,NULL)) ||
                                                 MAX(DECODE(COLUMN_POSITION, 4,&#39;, &#39;||&#39;&quot;&#39;||
                                                                SUBSTR(COLUMN_NAME,1,30)  ||&#39;&quot;&#39;,NULL)) ||
                                                 MAX(DECODE(COLUMN_POSITION, 5,&#39;, &#39;||&#39;&quot;&#39;||
                                                                SUBSTR(COLUMN_NAME,1,30)  ||&#39;&quot;&#39;,NULL)) ||
                                                 MAX(DECODE(COLUMN_POSITION, 6,&#39;, &#39;||&#39;&quot;&#39;||
                                                                SUBSTR(COLUMN_NAME,1,30)  ||&#39;&quot;&#39;,NULL)) ||
                                                 MAX(DECODE(COLUMN_POSITION, 7,&#39;, &#39;||&#39;&quot;&#39;||
                                                                SUBSTR(COLUMN_NAME,1,30)  ||&#39;&quot;&#39;,NULL)) ||
                                                 MAX(DECODE(COLUMN_POSITION, 8,&#39;, &#39;||&#39;&quot;&#39;||
                                                                SUBSTR(COLUMN_NAME,1,30)  ||&#39;&quot;&#39;,NULL)) ||
                                                 MAX(DECODE(COLUMN_POSITION, 9,&#39;, &#39;||&#39;&quot;&#39;||
                                                                SUBSTR(COLUMN_NAME,1,30)  ||&#39;&quot;&#39;,NULL)) ||
                                                 MAX(DECODE(COLUMN_POSITION, 10,&#39;, &#39;||&#39;&quot;&#39;||
                                                                SUBSTR(COLUMN_NAME,1,30)  ||&#39;&quot;&#39;,NULL)) COL_LIST
                                                 FROM DBA_IND_COLUMNS 
                                         WHERE TABLE_OWNER NOT IN (&#39;SYS&#39;, &#39;SYSTEM&#39;, &#39;OLAPSYS&#39;, &#39;SYSMAN&#39;, &#39;MDSYS&#39;)
                                         GROUP BY TABLE_OWNER, TABLE_NAME, INDEX_NAME ) COL
            WHERE CON.OWNER = COL.TABLE_OWNER 
            AND CON.TABLE_NAME = COL.TABLE_NAME  
            AND CON.COL_LIST = SUBSTR(COL.COL_LIST, 1, LENGTH(CON.COL_LIST) ) )  ;  </code></pre>
<h4 id="如果是ORACLE-11g或以上版本，数据库有分析函数LISTAGG的话，可以使用下面脚本"><a href="#如果是ORACLE-11g或以上版本，数据库有分析函数LISTAGG的话，可以使用下面脚本" class="headerlink" title="如果是ORACLE 11g或以上版本，数据库有分析函数LISTAGG的话，可以使用下面脚本"></a>如果是ORACLE 11g或以上版本，数据库有分析函数LISTAGG的话，可以使用下面脚本</h4><pre><code>    SELECT CASE 
                     WHEN B.TABLE_NAME IS NULL THEN &#39;NO INDEXED&#39; 
                     ELSE &#39;INDEXED&#39; 
                 END               AS STATUS, 
                 A.TABLE_OWNER     AS TABLE_OWNER, 
                 A.TABLE_NAME      AS TABLE_NAME, 
                 A.CONSTRAINT_NAME AS FK_NAME, 
                 A.FK_COLUMNS      AS FK_COLUMNS, 
                 B.INDEX_NAME      AS INDEX_NAME, 
                 B.INDEX_COLUMNS   AS INDEX_COLUMNS 
    FROM   (SELECT A.OWNER                              AS TABLE_OWNER, 
                                 A.TABLE_NAME                         AS TABLE_NAME, 
                                 A.CONSTRAINT_NAME                    AS CONSTRAINT_NAME, 
                                 LISTAGG(A.COLUMN_NAME, &#39;,&#39;) 
                                     WITHIN GROUP (ORDER BY A.POSITION) FK_COLUMNS 
                    FROM   DBA_CONS_COLUMNS A, 
                                 DBA_CONSTRAINTS B 
                    WHERE  A.CONSTRAINT_NAME = B.CONSTRAINT_NAME 
                                 AND B.CONSTRAINT_TYPE = &#39;R&#39; 
                                 AND A.OWNER = B.OWNER 
                                 AND A.OWNER NOT IN ( &#39;SYS&#39;, &#39;SYSTEM&#39;, &#39;OLAPSYS&#39;, &#39;SYSMAN&#39;, 
                                                                            &#39;MDSYS&#39; ) 
                    GROUP  BY A.OWNER, 
                                        A.TABLE_NAME, 
                                        A.CONSTRAINT_NAME) A, 
                 (SELECT TABLE_OWNER, 
                                 TABLE_NAME, 
                                 INDEX_NAME, 
                                 LISTAGG(C.COLUMN_NAME, &#39;,&#39;) 
                                     WITHIN GROUP (ORDER BY C.COLUMN_POSITION) INDEX_COLUMNS 
                    FROM   DBA_IND_COLUMNS C 
                    GROUP  BY TABLE_OWNER, 
                                        TABLE_NAME, 
                                        INDEX_NAME) B 
    WHERE  A.TABLE_NAME = B.TABLE_NAME(+) 
         AND A.TABLE_OWNER = B.TABLE_OWNER(+) 
         AND B.INDEX_COLUMNS(+) LIKE A.FK_COLUMNS 
                                                                 || &#39;%&#39; 
    ORDER  BY 1 DESC

            /*******************************************************************************************
    --脚本功能描述：
    --  对于数据库中外键缺少索引的字段，生成对应的索引（排除一些系统账号，例如sys、system）,如果外键索引超过十个字段
    --  那么这个脚本就不能正确的生成对应的索引，当然也很少有外键设置在超过10个字段的。另外索引表空
    --  空间跟数据表空间相同，如有分开的话，建议在此处再做调整。
    ********************************************************************************************/
    SELECT    &#39;CREATE INDEX &#39; || OWNER || &#39;.&#39; || REPLACE(CONSTRAINT_NAME,&#39;FK_&#39;,&#39;IX_&#39;) || 
                    &#39; ON &#39; || OWNER || &#39;.&#39; || TABLE_NAME || &#39; (&#39; || COL_LIST ||&#39;) TABLESPACE &#39; 
                    || (SELECT TABLESPACE_NAME FROM DBA_TABLES WHERE OWNER= CON.OWNER AND TABLE_NAME= CON.TABLE_NAME) 
                    AS  CREATE_INDEXES_ON_FOREIGN_KEY 
    FROM
             (SELECT CC.OWNER, CC.TABLE_NAME, CC.CONSTRAINT_NAME,
                         MAX(DECODE(POSITION, 1,     &#39;&quot;&#39; ||
                                        SUBSTR(COLUMN_NAME,1,30) ||&#39;&quot;&#39;,NULL)) ||
                         MAX(DECODE(POSITION, 2,&#39;, &#39;||&#39;&quot;&#39;||
                                        SUBSTR(COLUMN_NAME,1,30) ||&#39;&quot;&#39;,NULL)) ||
                         MAX(DECODE(POSITION, 3,&#39;, &#39;||&#39;&quot;&#39;||
                                        SUBSTR(COLUMN_NAME,1,30) ||&#39;&quot;&#39;,NULL)) ||
                         MAX(DECODE(POSITION, 4,&#39;, &#39;||&#39;&quot;&#39;||
                                        SUBSTR(COLUMN_NAME,1,30) ||&#39;&quot;&#39;,NULL)) ||
                         MAX(DECODE(POSITION, 5,&#39;, &#39;||&#39;&quot;&#39;||
                                        SUBSTR(COLUMN_NAME,1,30) ||&#39;&quot;&#39;,NULL)) ||
                         MAX(DECODE(POSITION, 6,&#39;, &#39;||&#39;&quot;&#39;||
                                        SUBSTR(COLUMN_NAME,1,30) ||&#39;&quot;&#39;,NULL)) ||
                         MAX(DECODE(POSITION, 7,&#39;, &#39;||&#39;&quot;&#39;||
                                        SUBSTR(COLUMN_NAME,1,30) ||&#39;&quot;&#39;,NULL)) ||
                         MAX(DECODE(POSITION, 8,&#39;, &#39;||&#39;&quot;&#39;||
                                        SUBSTR(COLUMN_NAME,1,30) ||&#39;&quot;&#39;,NULL)) ||
                         MAX(DECODE(POSITION, 9,&#39;, &#39;||&#39;&quot;&#39;||
                                        SUBSTR(COLUMN_NAME,1,30) ||&#39;&quot;&#39;,NULL)) ||
                         MAX(DECODE(POSITION, 10,&#39;, &#39;||&#39;&quot;&#39;||
                                        SUBSTR(COLUMN_NAME,1,30) ||&#39;&quot;&#39;,NULL)) COL_LIST
                         FROM DBA_CONSTRAINTS DC, DBA_CONS_COLUMNS CC
                         WHERE DC.OWNER = CC.OWNER
                         AND DC.CONSTRAINT_NAME = CC.CONSTRAINT_NAME
                         AND DC.CONSTRAINT_TYPE = &#39;R&#39;
                         AND DC.OWNER NOT IN (&#39;SYS&#39;, &#39;SYSTEM&#39;, &#39;OLAPSYS&#39;, &#39;SYSMAN&#39;, &#39;MDSYS&#39;, &#39;ADMIN&#39;)
                         GROUP BY CC.OWNER, CC.TABLE_NAME, CC.CONSTRAINT_NAME 
             ) CON
                WHERE NOT EXISTS (
                    SELECT 1 FROM
                                        ( SELECT TABLE_OWNER, TABLE_NAME,   
                                                 MAX(DECODE(COLUMN_POSITION, 1,     &#39;&quot;&#39;||
                                                                SUBSTR(COLUMN_NAME,1,30)  ||&#39;&quot;&#39;,NULL)) ||
                                                 MAX(DECODE(COLUMN_POSITION, 2,&#39;, &#39;||&#39;&quot;&#39;||
                                                                SUBSTR(COLUMN_NAME,1,30)  ||&#39;&quot;&#39;,NULL)) ||
                                                 MAX(DECODE(COLUMN_POSITION, 3,&#39;, &#39;||&#39;&quot;&#39;||
                                                                SUBSTR(COLUMN_NAME,1,30)  ||&#39;&quot;&#39;,NULL)) ||
                                                 MAX(DECODE(COLUMN_POSITION, 4,&#39;, &#39;||&#39;&quot;&#39;||
                                                                SUBSTR(COLUMN_NAME,1,30)  ||&#39;&quot;&#39;,NULL)) ||
                                                 MAX(DECODE(COLUMN_POSITION, 5,&#39;, &#39;||&#39;&quot;&#39;||
                                                                SUBSTR(COLUMN_NAME,1,30)  ||&#39;&quot;&#39;,NULL)) ||
                                                 MAX(DECODE(COLUMN_POSITION, 6,&#39;, &#39;||&#39;&quot;&#39;||
                                                                SUBSTR(COLUMN_NAME,1,30)  ||&#39;&quot;&#39;,NULL)) ||
                                                 MAX(DECODE(COLUMN_POSITION, 7,&#39;, &#39;||&#39;&quot;&#39;||
                                                                SUBSTR(COLUMN_NAME,1,30)  ||&#39;&quot;&#39;,NULL)) ||
                                                 MAX(DECODE(COLUMN_POSITION, 8,&#39;, &#39;||&#39;&quot;&#39;||
                                                                SUBSTR(COLUMN_NAME,1,30)  ||&#39;&quot;&#39;,NULL)) ||
                                                 MAX(DECODE(COLUMN_POSITION, 9,&#39;, &#39;||&#39;&quot;&#39;||
                                                                SUBSTR(COLUMN_NAME,1,30)  ||&#39;&quot;&#39;,NULL)) ||
                                                 MAX(DECODE(COLUMN_POSITION, 10,&#39;, &#39;||&#39;&quot;&#39;||
                                                                SUBSTR(COLUMN_NAME,1,30)  ||&#39;&quot;&#39;,NULL)) COL_LIST
                                                 FROM DBA_IND_COLUMNS 
                                         WHERE TABLE_OWNER NOT IN (&#39;SYS&#39;, &#39;SYSTEM&#39;, &#39;OLAPSYS&#39;, &#39;SYSMAN&#39;, &#39;MDSYS&#39;)
                                         GROUP BY TABLE_OWNER, TABLE_NAME, INDEX_NAME ) COL
            WHERE CON.OWNER = COL.TABLE_OWNER 
            AND CON.TABLE_NAME = COL.TABLE_NAME  
            AND CON.COL_LIST = SUBSTR(COL.COL_LIST, 1, LENGTH(CON.COL_LIST) ) )  ; 

                    --脚本使用分析函数LISTAGG， 适用于ORACLE 11g以及以上版本，如果数据库版本是Oracle 11g及以上，就可以使用此脚本替代上面脚本。

    SELECT &#39;CREATE INDEX &#39; 
                                || OWNER 
                                || &#39;.&#39; 
                                || REPLACE(CONSTRAINT_NAME,&#39;FK_&#39;,&#39;IX_&#39;) 
                                || &#39; ON &#39; 
                                || OWNER 
                                || &#39;.&#39; 
                                || TABLE_NAME 
                                || &#39; (&#39; 
                                || FK_COLUMNS 
                                ||&#39;) TABLESPACE &#39; 
                                || 
                 ( 
                                SELECT TABLESPACE_NAME 
                                FROM   DBA_TABLES 
                                WHERE  OWNER= CON.OWNER 
                                AND    TABLE_NAME= CON.TABLE_NAME) CREATE_INDEXES_ON_FOREIGN_KEY 
    FROM   ( 
                                    SELECT   CC.OWNER, 
                                                     CC.TABLE_NAME, 
                                                     CC.CONSTRAINT_NAME, 
                                                     LISTAGG(CC.COLUMN_NAME, &#39;,&#39;) WITHIN GROUP (ORDER BY CC.POSITION) FK_COLUMNS
                                    FROM     DBA_CONS_COLUMNS CC, 
                                                     DBA_CONSTRAINTS DC 
                                    WHERE    CC.CONSTRAINT_NAME = DC.CONSTRAINT_NAME 
                                    AND      DC.CONSTRAINT_TYPE = &#39;R&#39; 
                                    AND      CC.OWNER = DC.OWNER 
                                    AND      DC.OWNER NOT IN ( &#39;SYS&#39;, 
                                                                                        &#39;SYSTEM&#39;, 
                                                                                        &#39;OLAPSYS&#39;, 
                                                                                        &#39;SYSMAN&#39;, 
                                                                                        &#39;MDSYS&#39;, 
                                                                                        &#39;ADMIN&#39; ) 
                                    GROUP BY CC.OWNER, 
                                                     CC.TABLE_NAME, 
                                                     CC.CONSTRAINT_NAME) CON 
        WHERE NOT EXISTS 
                 ( 
                                SELECT 1 
                                FROM   ( 
                                                                SELECT   TABLE_OWNER, 
                                                                                 TABLE_NAME, 
                                                                                 INDEX_NAME,
                                                                                 LISTAGG(COLUMN_NAME, &#39;,&#39;) WITHIN GROUP (ORDER BY COLUMN_POSITION) FK_COLUMNS
                                                                FROM     DBA_IND_COLUMNS 
                                                                WHERE    INDEX_OWNER NOT IN ( &#39;SYS&#39;, 
                                                                                                                         &#39;SYSTEM&#39;, 
                                                                                                                         &#39;OLAPSYS&#39;, 
                                                                                                                         &#39;SYSMAN&#39;, 
                                                                                                                         &#39;MDSYS&#39;, 
                                                                                                                         &#39;ADMIN&#39; ) 

                                                                GROUP BY TABLE_OWNER, 
                                                                                 TABLE_NAME ,INDEX_NAME) COL 
                                WHERE  CON.OWNER = COL.TABLE_OWNER 
                                AND    CON.TABLE_NAME = COL.TABLE_NAME 
                                AND    CON.FK_COLUMNS = SUBSTR(COL.FK_COLUMNS, 1, LENGTH(CON.FK_COLUMNS)) ) 
                                ORDER BY 1;</code></pre>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/oracle/" rel="tag"># oracle</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item"></div>
      <div class="post-nav-item">
    <a href="/2020/10/11/hello-world/" rel="next" title="Hello World">
      Hello World <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86"><span class="nav-number">1.</span> <span class="nav-text">背景知识</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%A4%96%E9%94%AE%E7%94%B1%E4%BA%8E%E4%B8%9A%E5%8A%A1%E8%A7%84%E5%88%99%E5%86%85%E7%BD%AE%E5%9C%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%EF%BC%8C%E5%BC%80%E5%8F%91%E4%BA%BA%E5%91%98%E5%BE%88%E9%9A%BE%E6%B3%A8%E6%84%8F%E5%88%B0%E8%BF%99%E7%A7%8D%E4%B8%9A%E5%8A%A1%E8%A7%84%E5%88%99%E7%9A%84%E5%AD%98%E5%9C%A8%E4%BC%9A%E5%AF%BC%E8%87%B4%E6%AD%BB%E9%94%81%E6%A6%82%E7%8E%87%E7%9A%84%E6%8F%90%E5%8D%87%E3%80%82%E5%A4%96%E9%94%AE%E7%BA%A6%E6%9D%9F%E4%BC%9A%E5%AF%BC%E8%87%B4%E4%B8%A4%E4%B8%AA%E5%9F%BA%E6%9C%AC%E7%9A%84%E5%9C%BA%E6%99%AF%EF%BC%9A-%E4%B8%80%E6%98%AF%E5%88%A0%E9%99%A4%E4%B8%BB%E8%A1%A8%E6%97%B6%E9%9C%80%E8%A6%81%E5%90%8C%E6%AD%A5%E5%88%A0%E9%99%A4%E5%AD%90%E8%A1%A8%EF%BC%8C%E5%8D%B3%E9%9C%80%E8%A6%81%E9%94%81%E5%AE%9A%E5%AD%90%E8%A1%A8%E7%9A%84%E5%AF%B9%E5%BA%94%E8%AE%B0%E5%BD%95-%E3%80%82-%E4%BA%8C%E6%98%AF%E6%8F%92%E5%85%A5%E5%AD%90%E8%A1%A8%E9%9C%80%E8%A6%81%E7%A1%AE%E4%BF%9D%E4%B8%BB%E8%A1%A8%E8%AE%B0%E5%BD%95%E5%AD%98%E5%9C%A8%EF%BC%8C%E5%8D%B3%E9%9C%80%E8%A6%81%E9%94%81%E5%AE%9A%E4%B8%BB%E8%A1%A8%E7%9A%84%E5%AF%B9%E5%BA%94%E8%AE%B0%E5%BD%95%E3%80%82%E7%89%B9%E5%88%AB%E6%98%AF%E5%BD%93%E5%A4%96%E9%94%AE%E6%97%A0%E7%B4%A2%E5%BC%95%E6%97%B6%EF%BC%8COracle%E4%BC%9A%E5%9C%A8%E5%AD%90%E8%A1%A8%E4%B8%8A%E8%AF%B7%E6%B1%82SX%E9%94%81%EF%BC%8C%E8%BF%99%E4%B8%AA%E9%94%81%E5%92%8C%E4%B8%80%E8%88%AC%E6%9B%B4%E6%96%B0%E9%9C%80%E8%A6%81S%E9%94%81%E4%B8%8D%E5%85%BC%E5%AE%B9%EF%BC%8C%E5%8D%B3%E5%8F%AA%E8%A6%81%E5%AD%90%E8%A1%A8%E6%9C%89%E6%9B%B4%E6%96%B0%EF%BC%8C%E5%B0%B1%E6%97%A0%E6%B3%95%E8%8E%B7%E5%BE%97%E8%BF%99%E4%B8%AA%E9%94%81%E3%80%82%E4%B9%9F%E5%B0%B1%E6%98%AF%E8%AF%B4%EF%BC%8CSSX%E4%BD%BF%E5%B9%B6%E5%8F%91%E6%80%A7%E6%8E%A7%E5%88%B6%E4%BB%8E%E8%AE%B0%E5%BD%95%E8%BF%81%E7%A7%BB%E5%88%B0%E4%BA%86%E8%A1%A8%E6%A0%BC%E4%B8%8A%EF%BC%8C%E4%BB%8E%E8%80%8C%E4%BD%BF%E6%AD%BB%E9%94%81%E5%8F%91%E7%94%9F%E7%9A%84%E6%A6%82%E7%8E%87%E5%A4%A7%E5%B9%85%E5%BA%A6%E5%A2%9E%E5%8A%A0%E3%80%82"><span class="nav-number">1.0.0.0.0.1.</span> <span class="nav-text">外键由于业务规则内置在数据库中，开发人员很难注意到这种业务规则的存在会导致死锁概率的提升。外键约束会导致两个基本的场景：&#x3D;&#x3D;一是删除主表时需要同步删除子表，即需要锁定子表的对应记录**&#x3D;&#x3D;。**二是插入子表需要确保主表记录存在，即需要锁定主表的对应记录。特别是当外键无索引时，Oracle会在子表上请求SX锁，这个锁和一般更新需要S锁不兼容，即只要子表有更新，就无法获得这个锁。也就是说，SSX使并发性控制从记录迁移到了表格上，从而使死锁发生的概率大幅度增加。</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Oracle%E9%94%81"><span class="nav-number">2.</span> <span class="nav-text">Oracle锁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#TM-%E9%94%81%EF%BC%88%E8%A1%A8%E7%BA%A7%E9%94%81%EF%BC%89"><span class="nav-number">2.0.1.</span> <span class="nav-text">TM 锁（表级锁）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Oracle%E7%9A%84TX%E9%94%81%EF%BC%88%E8%A1%8C%E7%BA%A7%E9%94%81%E3%80%81%E4%BA%8B%E5%8A%A1%E9%94%81%EF%BC%89"><span class="nav-number">2.1.</span> <span class="nav-text">Oracle的TX锁（行级锁、事务锁）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%AD%BB%E9%94%81"><span class="nav-number">3.</span> <span class="nav-text">死锁</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C"><span class="nav-number">4.</span> <span class="nav-text">实验</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%95%B4%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8B%E6%8B%A5%E6%9C%89%E4%B8%BB%E5%A4%96%E9%94%AE%E5%85%B3%E7%B3%BB%E7%9A%84%E6%89%80%E6%9C%89%E8%A1%A8%EF%BC%88%E6%8E%92%E9%99%A4%E4%B8%80%E4%BA%9B%E7%B3%BB%E7%BB%9F%E7%94%A8%E6%88%B7%EF%BC%89"><span class="nav-number">4.0.0.1.</span> <span class="nav-text"># 查看整个数据库下拥有主外键关系的所有表（排除一些系统用户）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%80%93%E6%9F%A5%E7%9C%8B%E6%9F%90%E4%B8%AASchema%E4%B8%8B%E6%8B%A5%E6%9C%89%E4%B8%BB%E5%A4%96%E9%94%AE%E5%85%B3%E7%B3%BB%E7%9A%84%E6%89%80%E6%9C%89%E8%A1%A8"><span class="nav-number">4.0.0.2.</span> <span class="nav-text">–查看某个Schema下拥有主外键关系的所有表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%80%93%E6%9F%A5%E7%9C%8B%E6%9F%90%E4%B8%AA%E5%85%B7%E4%BD%93%E7%9A%84%E8%A1%A8%E6%98%AF%E5%90%A6%E5%92%8C%E5%85%B6%E5%AE%83%E8%A1%A8%E6%8B%A5%E6%9C%89%E4%B8%BB%E5%A4%96%E9%94%AE%E5%85%B3%E7%B3%BB"><span class="nav-number">4.0.0.3.</span> <span class="nav-text">–查看某个具体的表是否和其它表拥有主外键关系</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A5%E4%B8%8B%E6%9D%A5%E6%88%91%E4%BB%AC%E8%A6%81%E6%89%BE%E5%87%BA%E5%9C%A8%E5%85%B7%E4%BD%93%E7%9A%84%E5%A4%96%E9%94%AE%E5%AD%97%E6%AE%B5%E6%98%AF%E5%90%A6%E6%9C%89%E7%B4%A2%E5%BC%95%EF%BC%8C%E8%84%9A%E6%9C%AC%E5%A6%82%E4%B8%8B%E6%89%80%E7%A4%BA%EF%BC%9A"><span class="nav-number">4.0.0.4.</span> <span class="nav-text">接下来我们要找出在具体的外键字段是否有索引，脚本如下所示：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E6%98%AFORACLE-11g%E6%88%96%E4%BB%A5%E4%B8%8A%E7%89%88%E6%9C%AC%EF%BC%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9C%89%E5%88%86%E6%9E%90%E5%87%BD%E6%95%B0LISTAGG%E7%9A%84%E8%AF%9D%EF%BC%8C%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%E4%B8%8B%E9%9D%A2%E8%84%9A%E6%9C%AC"><span class="nav-number">4.0.0.5.</span> <span class="nav-text">如果是ORACLE 11g或以上版本，数据库有分析函数LISTAGG的话，可以使用下面脚本</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">7</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
